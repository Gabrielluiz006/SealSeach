<?php
require_once './seguranca_usuario.php';
require_once './enviaEmail_usuario.php';

try {
    $con = getConexao();
    /* verifica se existe algum problema de conexao, caso exista, redireciona para pagefound
     * evitando assim, mostrar os diretorios da pasta
     */
    if($con === null) {
        header('Location: ./pagefound.php');
        exit();
    }
    $con->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
    
    $btn_reenviar = filter_input(INPUT_POST, 'reenviar-email', FILTER_SANITIZE_SPECIAL_CHARS);
    $email = filter_input(INPUT_POST, 'email', FILTER_VALIDATE_EMAIL);
    
    if(isset($btn_reenviar,$email) && !empty($btn_reenviar) && !empty($email)) {
        
        $sql_busca_email = 'SELECT hash_master FROM cliente WHERE email = :email;';
        
        $stmt = $con->prepare($sql_busca_email);
        
        $stmt->bindParam(':email', $email);
        
        if(!$stmt->execute()) {
            $_SESSION['msgDeVerificacaoDeReenvio'] = "NÃ£o foi possivel enviar o email";
            $con = null;
            header('Location: ../PP1_FRONT/Cadastro.php');
        }
        
        $result = $stmt->fetchAll(PDO::FETCH_ASSOC);
        
        $token = hash('sha512', TEXT_SEGURANCA.$result[0]['hash_master']);
        
        if(confirmaCadastro($email,$token)) {
                $_SESSION['msgDeVerificacaoDeReenvio'] = "O email foi enviado,caso nÃ£o receba, tente novamente mais tarde";
                $_SESSION['corMsg'] = true;
                $_SESSION['email'] = $email;
                $_SESSION['reenviaEmail'] = true;
                unset($_SESSION['nomeForm']);
                unset($_SESSION['emailForm']);
                unset($_SESSION['cpfForm']);
                $con = null;
                header('Location: ../PP1_FRONT/Cadastro.php');
                exit();

            }else {
                $_SESSION['msgDeVerificacaoDeReenvio'] = "NÃ£o foi possÃ­vel enviar o email";
                $_SESSION['reenviaEmail'] = true;
                $con = null;
                header('Location: ../PP1_FRONT/Cadastro.php');
                exit();
            }
        
    }else {
        $con = null;
        header('Location: ../PP1_FRONT/Cadastro.php');
    }
    
} catch (PDOException $ex) {
    echo $ex->getCode(); echo $ex->getMessage();
}


