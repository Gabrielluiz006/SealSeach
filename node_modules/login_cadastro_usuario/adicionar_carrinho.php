<?php


/* php.ini
session.cookie_httponly=1;
session.cookie_secure=1;
session.use_only_cookies=1; */

define('TEXT_SEGURANCA', 'W4r/N0Mor3Trouble@&St0pWar@');

session_cache_expire(10);
$marcaTempoCache = session_cache_expire();

        
session_start();

$_SESSION['marcaTempoCache'] = $marcaTempoCache;
// aqui renova o id da sessa caso tenha passado o tempo
if($_SESSION['marcaTempoCache'] <= 3) {
    session_regenerate_id();
    /*
     * ainda vou modificar essa renovacao de sessao
     */
}

// cria um token de sessao
$tokenSessao = hash('sha512', $_SERVER['REMOTE_ADDR'].$_SERVER['HTTP_USER_AGENT'].TEXT_SEGURANCA.session_id());

/* verifica se existe algum token da sessao existe
 * caso exista, ele verifica se é igual ao da sessao existente
 */
if(isset($_SESSION['tokenUsuarioLogado'])) {
    if(empty($_SESSION['email']) || !hash_equals($tokenSessao, $_SESSION['tokenUsuarioLogado'])) {
        header('Location: ../login_cadastro_usuario/logout_usuario.php');
    }
}

require_once './conexao.php';

try {
    $con = getConexao();
    if(!isset($con)) {
        header('Location: ./pagefound.php');
    }
    $con->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
    
    // pegando o numero do produto e sua respectiva loja
    $numeroProduto = filter_input(INPUT_GET, 'produto', FILTER_VALIDATE_INT);
    $lojaProduto = filter_input(INPUT_GET, 'loja', FILTER_SANITIZE_SPECIAL_CHARS);
    
    // verifica se o numero e a loja são validos
    if($numeroProduto >= 0 && $numeroProduto <= 29 && is_numeric($numeroProduto)
    && ($lojaProduto === 'Kabum' || $lojaProduto === 'Pichau')) {
        
        echo "sucess";
        $con = null;
    }else {
        $con = null;
        header('Location: ../PP1_FRONT/Produtos.php');
    }
    
} catch (PDOException $ex) {
    $ex->getMessage();
}
