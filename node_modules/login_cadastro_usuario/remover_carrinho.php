<?php
require_once './seguranca_usuario.php';

try {
    $con = getConexao();
    /* verifica se existe algum problema de conexao, caso exista, redireciona para pagefound
     * evitando assim, mostrar os diretorios da pasta
     */
    if($con === null) {
        header('Location: ./pagefound.php');
        exit();
    }
    $con->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
   
    // pegando o numero do produto e sua respectiva loja
    $numeroProduto = filter_input(INPUT_GET, 'produto', FILTER_VALIDATE_INT);
    $lojaProduto = filter_input(INPUT_GET, 'loja', FILTER_SANITIZE_SPECIAL_CHARS);
    
    if(is_numeric($numeroProduto)) {
        // faz o casting do numero do produto
        $numeroProduto = (int) $numeroProduto;
    }else {
        // retorna para pagina de produto caso o valor nao seja numero
        $con = null;
        header('Location: ../PP1_FRONT/'.$_SESSION['urlRequest']);
    }
    
    // verifica se o numero e a loja sÃ£o validos
    if($numeroProduto >= 0 && ($lojaProduto === 'kabum' || $lojaProduto === 'pichau') && $token_usuario) {
        
        $sql_busca_id_cliente = 'SELECT id FROM cliente WHERE token_session = :token_session;';
        
        $stmt = $con->prepare($sql_busca_id_cliente);
        
        $stmt->bindParam(':token_session', $token_usuario);
        
        if(!$stmt->execute()) {
            $con = null;
            header('Location: ../PP1_FRONT/'.$_SESSION['urlRequest']);
            exit();
        }
        
        $result = $stmt->fetchAll(PDO::FETCH_ASSOC);
        
        if(count($result[0]) === 0) {
            $con = null;
            header('Location: ./logout_usuario.php');
            exit();
        }
        
        $idCliente = $result[0]['id'];
        
        $sql_verifica_propaganda = 'SELECT id FROM carrinho WHERE id_cliente = :id_cliente AND id_propaganda = :id_propaganda;';
        
        $stmt = $con->prepare($sql_verifica_propaganda);
        
        $stmt->bindParam(':id_cliente', $idCliente);
        $stmt->bindParam(':id_propaganda', $numeroProduto);
        
        if(!$stmt->execute()) {
            $_SESSION['produtoAdicionado'] = true;
            $con = null;
            header('Location: ../PP1_FRONT/'.$_SESSION['urlRequest']);
            exit();
        }
        
        $result = $stmt->fetchAll(PDO::FETCH_ASSOC);
        
        $id_carr = $result[0]['id'];
        
        $sql = 'DELETE FROM carrinho WHERE id = :id;';
        
        $stmt = $con->prepare($sql);
        
        $stmt->bindParam(':id', $id_carr);
        
        if($stmt->execute()) {
            $_SESSION['produtoAdicionado'] = true;
            $con = null;
            header('Location: ../PP1_FRONT/'.$_SESSION['urlRequest']);
            
        }else {
            $con = null;
            header('Location: ../PP1_FRONT/'.$_SESSION['urlRequest']);
        }
        
    }else {
        $con = null;
        header('Location: ../PP1_FRONT/'.$_SESSION['urlRequest']);
    }
    
} catch (PDOException $ex) {
    $ex->getMessage();
}

