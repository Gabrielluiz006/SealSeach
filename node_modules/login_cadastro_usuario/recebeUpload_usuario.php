<?php
require_once './seguranca_usuario.php';

$uploaddir = '../login_cadastro_usuario/foto-usuario/';

$nome_foto = basename($_FILES['foto-usuario']['name']);

if(strpos($nome_foto, ".png")) {
    echo "<br><br>Arquivo pode passar<br>";
    $nome_foto = rand(0, 9999999).".png";
    
}else if(strpos($nome_foto, ".jpeg")) {
    echo "<br><br>Arquivo pode passar<br>";
    $nome_foto = rand(0, 9999999).".jpeg";
}else {
    $_SESSION['msgUploadFail'] = "Por favor, a extens達o tem que ser png ou jpeg";
    unset($_FILES);
    header('Location: ../PP1_FRONT/'.$_SESSION['urlRequest']);
    exit();
}

$erro = $_FILES['foto-usuario']['error'];

if($erro != 0) {
    exit();
}

$uploadfile = $uploaddir . $nome_foto;


    try {
        $con = getConexao();
        if($con === null) {
            header('Location: ./pagefound.php');
        }
        $con->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);

        $sql_busca_id = 'SELECT id,caminho_foto FROM cliente WHERE email = :email;';

        $stmt = $con->prepare($sql_busca_id);

        $stmt->bindParam(':email', $_SESSION['email']);

        if(!$stmt->execute()) {
            $_SESSION['msgUploadFail'] = "Desculpe, arquivo n達o pode ser enviado";
            $con = null;
            header('Location: ../PP1_FRONT/'.$_SESSION['urlRequest']);
        }

        $result = $stmt->fetchAll(PDO::FETCH_ASSOC);
        
        if(count($result[0]) === 2) {
            $uploadfile = $result[0]['caminho_foto'];
        }
        
        if (!move_uploaded_file($_FILES['foto-usuario']['tmp_name'], $uploadfile)){
            $_SESSION['msgUploadFail'] = "Desculpe, arquivo n達o pode ser enviado";
            unset($_FILES);
            header('Location: ../PP1_FRONT/'.$_SESSION['urlRequest']);
            exit();
        }
        
        $id = $result[0]['id'];

        $sql_guarda_caminho = 'UPDATE cliente SET caminho_foto = :caminho_foto WHERE id = :id;';

        $stmt = $con->prepare($sql_guarda_caminho);

        $stmt->bindParam(':id', $id);

        $stmt->bindParam(':caminho_foto', $uploadfile);

        if(!$stmt->execute()) {
            $_SESSION['msgUploadFail'] = "Desculpe, arquivo n達o pode ser enviado";
            $con = null;
            header('Location: ../PP1_FRONT/Perfil.php');
        }
        $con = null;
        header('Location: ../PP1_FRONT/'.$_SESSION['urlRequest']);
        
    } catch (PDOException $ex) {
        echo $ex->getCode(); echo $ex->getMessage();
    }


//echo $_FILES['foto-usuario']['name']."<br>";
//
//echo $_FILES['foto-usuario']['type']."<br>";
//
//echo ($_FILES['foto-usuario']['size'] )."<br>";
//
//echo $_FILES['foto-usuario']['tmp_name']."<br>";
//
//echo $_FILES['foto-usuario']['error']."<br>";

