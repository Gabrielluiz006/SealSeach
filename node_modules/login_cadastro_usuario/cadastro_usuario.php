<?php
require_once './recaptchalib.php';
require_once './seguranca_usuario.php';

// definir a chave secreta
$secret = "6LeaQJUUAAAAAF929oqAUZGJfA6H2jyHF5hRugec";

// verificar a chave secreta
$response = null;
$reCaptcha = new ReCaptcha($secret);

if ($_POST["g-recaptcha-response"]) {
    $response = $reCaptcha->verifyResponse($_SERVER["REMOTE_ADDR"], $_POST["g-recaptcha-response"]);
}

// deu tudo certo?
if ($response != null && $response->success) {
    // processar o formulario
    
require_once './conexao.php';
require_once './valida-form/validaCpf.php';
//require_once './valida-form/validaEmail.php';

try {
    $con = getConexao();
    /* verifica se existe algum problema de conexao, caso exista, redireciona para pagefound
     * evitando assim, mostrar os diretorios da pasta
     */
    if($con === null) {
        header('Location: ./pagefound.php');
    }
    $con->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
    
    $cadastro = filter_input(INPUT_POST, 'cadastrar', FILTER_SANITIZE_SPECIAL_CHARS);

    // recebendo os dados do formulario e usando filtros
    $nome = filter_input(INPUT_POST, 'nome', FILTER_SANITIZE_SPECIAL_CHARS);
    $email = filter_input(INPUT_POST, 'email', FILTER_VALIDATE_EMAIL);
    $senha = filter_input(INPUT_POST, 'senha', FILTER_SANITIZE_SPECIAL_CHARS);
    $cpf = filter_input(INPUT_POST, 'cpf', FILTER_SANITIZE_SPECIAL_CHARS);
    $dataNasc = filter_input(INPUT_POST, 'data_nasc', FILTER_SANITIZE_SPECIAL_CHARS);
    
    // verifica se cpf tem valor
    if(isset($cpf)) {
        $cpfValido = true;
        // ele testa pra ver se o cpf é valido
        if(!validaCpf($cpf)) {
            $cpfValido = false;
            $_SESSION['msgDeVerificacaoCpf'] = "* CPF invalido";
        }
    }
        
    // verifica se nome, email, senha e data de nascimento estao vazios
    if(empty($nome) || empty($email) || empty($senha) || strlen($senha) < 8 || empty($cpf) || !$cpfValido || empty($dataNasc)) {
        
        if(empty($nome)) {
            $_SESSION['msgDeVerificacaoNome'] = "* Nome é necessário";
        }
        
        if(empty($email)) {
            $_SESSION['msgDeVerificacaoEmail'] = "* Email é necessário";
        }
        
        if(empty($senha)) {
            $_SESSION['msgDeVerificacaoSenha'] = "* Senha é necessário";
        }else if(strlen($senha) < 8) {
            $_SESSION['msgDeVerificacaoSenha'] = 'As senhas devem ser de 8 caracteres no minino';
        }
        
        if(empty ($cpf)) {
            $_SESSION['msgDeVerificacaoCpf'] = "* CPF é necessário";
        }
        
        if(empty($dataNasc)) {
            $_SESSION['msgDeVerificacaoNasc'] = "* data de nascimento é necessário";
        }
        // salvando valores para evitar reescrita no formulario
        $_SESSION['nomeForm'] = (isset($_POST['nome'])) ? $_POST['nome'] : '';
        $_SESSION['emailForm'] = (isset($_POST['email'])) ? $_POST['email'] : '';
        $_SESSION['cpfForm'] = (isset($_POST['cpf'])) ? $_POST['cpf'] : '';
        $con = null;
        header('Location: ../PP1_FRONT/Cadastro.php');
        exit();
        
    }
    
    // a partir daqui é o codigo de cadastro
    
        // verificar se o email ja esta sendo usado
        $sql_verifica_email = 'SELECT email FROM cliente WHERE id = (SELECT id FROM cliente WHERE email = :verificarEmail);';
        $stmtVerificarEmail = $con->prepare($sql_verifica_email);
        $stmtVerificarEmail->bindParam('verificarEmail', $email);
        
        if($stmtVerificarEmail->execute()) {
            $result = $stmtVerificarEmail->fetchAll(PDO::FETCH_ASSOC);
            if(count($result)) {
                $_SESSION['msgDeVerificacaoEmail'] = "* Email já está sendo usado";
                $con = null;
                header('Location: ../PP1_FRONT/Cadastro.php');
                exit();
            }
        }
        
        // preparando sql
        $sql = 'INSERT INTO cliente (nome,email,senha,cpf,data_nascimento,hash_master) '
                .'VALUES (:nome,:email,:senha,:cpf,:data_nasc,:hash_master);';
        $stmt = $con->prepare($sql);

        // trocar os valores do statement com bindParam
        $stmt->bindParam('nome', $nome);
        
        // crio um hash master
        $hash = password_hash(TEXT_SEGURANCA, PASSWORD_ARGON2I);
        
        // passando a senha por uma funcao hash usando o hash master junto
        $senha = hash('sha512', $senha.$hash);
        
        $stmt->bindParam(':email', $email);
        $stmt->bindParam(':senha', $senha);
        $stmt->bindParam(':cpf', $cpf);
        $stmt->bindParam(':data_nasc', $dataNasc);
        $stmt->bindParam(':hash_master', $hash);
        
        // inserindo o usuario no banco
        if($stmt->execute()) {
            require_once './enviaEmail_usuario.php';
            
            if(confirmaCadastro($email)) {
                $_SESSION['msgDeVerificacao'] = "Por favor, verifique seu email para confirma o cadastro";
                $_SESSION['email'] = $email;
                unset($_SESSION['cpfForm']);
                $con = null;
                header('Location: ../PP1_FRONT/Cadastro.php');

            }else {
                $_SESSION['msgDeVerificacao'] = "Não foi possível enviar o email";
                $con = null;
                header('Location: ../PP1_FRONT/Cadastro.php');
            }
                        
        }else {
            $_SESSION['msgDeVerificacao'] = "Não foi possivel cadastrar";
            $con = null;
            header('Location: ../PP1_FRONT/Cadastro.php');
        }

}catch(PDOException $ex) {
    echo $ex->getCode(); echo $ex->getMessage();
}

}else {
    $_SESSION['msgDeVerificacao'] = "* Recaptcha não foi marcado";
    unset($_POST);
    header('Location: ../PP1_FRONT/'.$_SESSION['urlRequest']);
}