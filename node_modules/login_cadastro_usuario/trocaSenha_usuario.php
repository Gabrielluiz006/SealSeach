<?php
require_once '../login_cadastro_usuario/seguranca_usuario.php';
require_once '../login_cadastro_usuario/conexao.php';

    try {
        if(isset($_POST['nova-senha'],$_POST['conf-senha'],$_POST['email'],$_POST['token']) && !empty($_POST['email']) && !empty($_POST['token'])) {
            $con = getConexao();
            /* verifica se existe algum problema de conexao, caso exista, redireciona para pagefound
             * evitando assim, mostrar os diretorios da pasta
             */
            if($con === null) {
                header('Location: ../pagefound.php');
            }
            $con->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
            
            // valida as senhas
            $senha = filter_input(INPUT_POST, 'nova-senha', FILTER_SANITIZE_SPECIAL_CHARS);
            $confSenha = filter_input(INPUT_POST, 'conf-senha', FILTER_SANITIZE_SPECIAL_CHARS);
            $email = filter_input(INPUT_POST, 'email', FILTER_VALIDATE_EMAIL);
            $token_user = filter_input(INPUT_POST, 'token', FILTER_SANITIZE_SPECIAL_CHARS);
            
            
            if($senha === $confSenha) {
                $sql = 'SELECT id,hash_master FROM cliente WHERE email = :email AND token_mudaSenha = :token AND tempo_senha > NOW();';
                
                $stmt = $con->prepare($sql);
                
                $stmt->bindParam(':email',$email);
                $stmt->bindParam(':token', $token_user);
                
                if($stmt->execute()) {
                    $result = $stmt->fetchAll(PDO::FETCH_ASSOC);
                    
                    // verifica se foi retornado algo
                    if($stmt->rowCount() === 0 || count($result[0]) === 0) {
                        $_SESSION['msgDeVerificacao'] = "* O link expirou, por favor solicite outro link";
                        $con = null;
                        header('Location: ../PP1_FRONT/EsqueceuSenha.php');
                    }
                    
                    $id = $result[0]['id'];
                    $hash = $result[0]['hash_master'];
                    $senha = hash('sha512', $senha.$hash);
                    
                    $sql = 'UPDATE cliente SET senha = :senha WHERE id = :id;';
                    
                    $stmt = $con->prepare($sql);
                    
                    $stmt->bindParam(':senha', $senha);
                    $stmt->bindParam(':id', $id);
                    
                    if($stmt->execute()) {
                        // assim que a senha for redefinida, deixa o tempo com valor null
                        $sql_muda_tempo_senha = 'UPDATE cliente SET token_mudaSenha = NULL, tempo_senha = NULL WHERE id = :id;';
                        
                        $stmt = $con->prepare($sql_muda_tempo_senha);
                        
                        $stmt->bindParam(':id', $id);
                        
                        $stmt->execute();
                        
                        // verifica se foi retornado algo
                        if($stmt->rowCount() === 0 || count($result[0]) === 0) {
                            $_SESSION['msgDeVerificacao'] = "* O link expirou, por favor solicite outro link";
                            $con = null;
                            header('Location: ../PP1_FRONT/EsqueceuSenha.php');
                        }
                        
                        $_SESSION['msgDeVerificacao'] = "Senha alterada com sucesso";
                        unset($_POST['token']);
                        unset($_GET['token']);
                        $con = null;
                        header('Location: ../PP1_FRONT/NovaSenha.php');
                        
                    }else {
                        $_SESSION['msgDeVerificacao'] = "As senham não coincidem";
                        $con = null;
                        header('Location: ../PP1_FRONT/NovaSenha.php?email='.$email.'&token='.$token_user);
                    }
                    
                }else {
                    $_SESSION['msgDeVerificacao'] = "* O link expirou, por favor solicite outro link";
                    $con = null;
                    header('Location: ../PP1_FRONT/NovaSenha.php?email='.$email.'&token='.$token_user);
                }
                
            }else {
                $_SESSION['msgDeVerificacao'] = "As senham não coincidem";
                $con = null;
                header('Location: ../PP1_FRONT/NovaSenha.php?email='.$email.'&token='.$token_user);
            }
            
        }else {
            $_SESSION['msgDeVerificacao'] = "Não foi possivel atender o pedido";
            $con = null;
            header('Location: ../PP1_FRONT/NovaSenha.php');
        }
        
    } catch (PDOException $ex) {
        echo $ex->getCode(); echo $ex->getMessage();
    }
?>