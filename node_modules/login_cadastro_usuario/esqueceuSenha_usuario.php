<?php
require_once './seguranca_usuario.php';
require_once './conexao.php';

try {
    $con = getConexao();
    /* verifica se existe algum problema de conexao, caso exista, redireciona para pagefound
     * evitando assim, mostrar os diretorios da pasta
     */
    if($con === null) {
        header('Location: ./pagefound.php');
    }
    $con->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
    
    // os dados do formulario
    $btn_esqueceuSenha = filter_input(INPUT_POST, 'esqueceu-senha', FILTER_SANITIZE_SPECIAL_CHARS);
    $email = filter_input(INPUT_POST, 'redefine-email', FILTER_VALIDATE_EMAIL);
    
    if(isset($btn_esqueceuSenha,$email) && $email != '') {
        
        // prepara o sql para verificar se o email passado pelo usuario existe no banco
        $sql = 'SELECT email FROM cliente WHERE id = (SELECT id FROM cliente WHERE email = :email);';
        
        $stmt = $con->prepare($sql);
        
        $stmt->bindParam(':email', $email);
        
        // verifica se o email existe
        if($stmt->execute()) {
            require_once './enviaEmail_usuario.php';
            if (redefineSenha($email)) {
                $con = null;
                header('Location: ../PP1_FRONT/EsqueceuSenha.php');
                
            }else {
                $_SESSION['msgDeVerificacao'] = 'NÃ£o foi possÃ­vel enviar o email';
                header('Location: ../PP1_FRONT/EsqueceuSenha.php');
            }
            
        }else {
            //caso o email nao exista
            $_SESSION['msgDeVerificacao'] = "* Email nÃ£o existe";
            $con = null;
            header('Location: ../PP1_FRONT/EsqueceuSenha.php');
            
        }
        
    }else {
        // caso o usuario nao digite um email
        $_SESSION['msgDeVerificacao'] = "* Digite um Email";
        $con = null;
        header('Location: ../PP1_FRONT/EsqueceuSenha.php');
    }
    
} catch (PDOException $ex) {
    echo $ex->getCode(); echo $ex->getMessage();
}

