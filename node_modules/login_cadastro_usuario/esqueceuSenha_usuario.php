<?php
require_once './seguranca_usuario.php';
require_once './conexao.php';

try {
    $con = getConexao();
    /* verifica se existe algum problema de conexao, caso exista, redireciona para pagefound
     * evitando assim, mostrar os diretorios da pasta
     */
    if($con === null) {
        header('Location: ./pagefound.php');
    }
    $con->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
    
    // os dados do formulario
    $btn_esqueceuSenha = filter_input(INPUT_POST, 'esqueceu-senha', FILTER_SANITIZE_SPECIAL_CHARS);
    $email = filter_input(INPUT_POST, 'redefine-senha', FILTER_VALIDATE_EMAIL);
    
    if(isset($btn_esqueceuSenha,$email) && !empty($email)) {
        
        // prepara o sql para verificar se o email passado pelo usuario existe no banco
        $sql = 'SELECT id,email FROM cliente WHERE id = (SELECT id FROM cliente WHERE email = :email);';
        
        $stmt = $con->prepare($sql);
        
        $stmt->bindParam(':email', $email);
        
        // verifica se o email existe
        if($stmt->execute()) {
            require_once './enviaEmail_usuario.php';
            
            $result = $stmt->fetchAll(PDO::FETCH_ASSOC);
            
            // verifica se foi retornado algo
            if($stmt->rowCount() === 0 || count($result[0]) === 0) {
                //caso o email nao exista
                $_SESSION['msgDeVerificacao'] = "* Email não existe";
                $con = null;
                header('Location: ../PP1_FRONT/EsqueceuSenha.php');
            }
            
            $idCliente = $result[0]['id'];
                
            $date = new DateTime();
            $hour = (int) $date->format("H") + 2;
            $minute = (int) $date->format("i");
            $date->setTime($hour, $minute);
            $tempo = $date->format("Y-m-d H:i:s"); // salva a data e hora atual
                
            $sql_marca_tempo = 'UPDATE cliente SET tempo_senha = :marca_tempo,token_mudaSenha = :tokenSenha WHERE id = :id';
                
            $stmt = $con->prepare($sql_marca_tempo);
                
            $stmt->bindParam(':id', $idCliente);
            $stmt->bindParam(':marca_tempo', $tempo);
            
            $hash = password_hash(TEXT_SEGURANCA, PASSWORD_ARGON2I); // cria um password hash 
            $token_mudaSenha = hash('sha512', TEXT_SEGURANCA.$hash); // usa ele para cria um hashing para salvar no banco
            $stmt->bindParam(':tokenSenha', $token_mudaSenha);
                        
            if($stmt->execute()) {
                
                $result = $stmt->fetchAll(PDO::FETCH_ASSOC);
                
                // verifica se foi retornado algo
                if($stmt->rowCount() === 0 || count($result[0]) === 0) {
                    //caso o email nao exista
                    $_SESSION['msgDeVerificacao'] = "* Email não existe";
                    $con = null;
                    header('Location: ../PP1_FRONT/EsqueceuSenha.php');
                }
                
                if (redefineSenha($email,$token_mudaSenha)) {
                    $_SESSION['msgDeVerificacao'] = 'O email foi enviado, por favor verifique seu email';
                    $con = null;
                    header('Location: ../PP1_FRONT/EsqueceuSenha.php');
                        
                }else {
                    $_SESSION['msgDeVerificacao'] = 'Não foi possível enviar o email';
                    $con = null;
                    header('Location: ../PP1_FRONT/EsqueceuSenha.php');
                        
                }
                    
            }else {
                $_SESSION['msgDeVerificacao'] = 'Não foi possível enviar o email';
                $con = null;
                header('Location: ../PP1_FRONT/EsqueceuSenha.php');
                    
            }
            
        }else {
            //caso o email nao exista
            $_SESSION['msgDeVerificacao'] = "* Email não existe";
            $con = null;
            header('Location: ../PP1_FRONT/EsqueceuSenha.php');
            
        }
        
    }else {
        // caso o usuario nao digite um email
        $_SESSION['msgDeVerificacao'] = "* Digite um Email";
        $con = null;
        header('Location: ../PP1_FRONT/EsqueceuSenha.php');
    }
    
} catch (PDOException $ex) {
    echo $ex->getCode(); echo $ex->getMessage();
}

