<?php
require_once '../login_cadastro_usuario/seguranca_usuario.php';

try {
    if(isset($_GET['email'],$_GET['token'])) {
        
        $con = getConexao();
        /* verifica se existe algum problema de conexao, caso exista, redireciona para pagefound
         * evitando assim, mostrar os diretorios da pasta
         */
        if($con === null) {
            header('Location: ../pagefound.php');
        }
        $con->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
        
        // valida o email recebido
        $email = filter_input(INPUT_GET, 'email', FILTER_VALIDATE_EMAIL);
        $token_user = filter_input(INPUT_GET, 'token', FILTER_SANITIZE_SPECIAL_CHARS);
        
        $sql = 'SELECT token_mudaSenha FROM cliente WHERE email = :email AND tempo_senha > NOW();';
        
        $stmt = $con->prepare($sql);
        
        $stmt->bindParam(':email', $email);
        
        if($stmt->execute()) {
            $result = $stmt->fetchAll(PDO::FETCH_ASSOC);
            
            $tokenBanco = $result[0]['token_mudaSenha'];
            
            if(($stmt->rowCount() !== 2 || count($result[0]) !== 2) && !hash_equals($tokenBanco, $token_user)) {
                $_SESSION['msgDeVerificacao'] = "* O link expirou, por favor solicite outro link";
                $con = null;
                header('Location: ../PP1_FRONT/EsqueceuSenha.php');
            }
            
        }else {
            $_SESSION['msgDeVerificacao'] = "* O link expirou, por favor solicite outro link";
            $con = null;
            header('Location: ../../PP1_FRONT/EsqueceuSenha.php');
        }
        
    }

} catch (PDOException $ex) {
    echo $ex->getCode(); echo $ex->getMessage();
}    
