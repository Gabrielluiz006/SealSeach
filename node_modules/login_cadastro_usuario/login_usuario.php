<?php
require_once './recaptchalib.php';
require_once './seguranca_usuario.php';

// definir a chave secreta
$secret = "6LeaQJUUAAAAAF929oqAUZGJfA6H2jyHF5hRugec";

// verificar a chave secreta
$response = null;
$reCaptcha = new ReCaptcha($secret);


if ($_POST["g-recaptcha-response"]) {
    $response = $reCaptcha->verifyResponse($_SERVER["REMOTE_ADDR"], $_POST["g-recaptcha-response"]);
}

// deu tudo certo?
if ($response != null && $response->success) {
    // processar o formulario

try {
    $con = getConexao();
    /* verifica se existe algum problema de conexao, caso exista, redireciona para pagefound
     * evitando assim, mostrar os diretorios da pasta
     */
    if($con === null) {
        header('Location: ./pagefound.php');
    }
    $con->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
    
    // verifica se as variaveis globais tem algum valor
    $login = filter_input(INPUT_POST, 'login', FILTER_SANITIZE_STRING);
    $email = filter_input(INPUT_POST, 'email-login', FILTER_VALIDATE_EMAIL);
    $senha = filter_input(INPUT_POST, 'senha-login', FILTER_SANITIZE_SPECIAL_CHARS);
    
    // codigo para logar
    if(isset($email,$senha,$login) && !empty($email) && !empty($senha)){
        
        // busca no banco os dados com base no email
        $sql = 'SELECT id,nome,cpf,email,senha,data_nascimento,hash_master,confirma_email FROM cliente WHERE id = (SELECT id FROM cliente WHERE email = :email);';
        $qtdParamSql = 8;
        
        // prepara sql
        $stmt = $con->prepare($sql);
        
        $stmt->bindParam(':email', $email);
           
            if($stmt->execute()) {
                $result = $stmt->fetchAll(PDO::FETCH_ASSOC);
                
                if($result[0]['confirma_email'] != 1) {
                    // caso o execute do update falhe
                    $_SESSION['msgLoginFalha'] = "* Por favor, acesse o seu email para validar seu cadastro";
                    unset($_SESSION['logado']);
                    unset($senha);
                    $con = null;
                    header('Location: ../PP1_FRONT/'.$_SESSION['urlRequest']);
                }
                
                $idCliente = $result[0]['id'];
                // pego o hash master
                $hash = $result[0]['hash_master'];
                
                $senha = hash('sha512', $senha.$hash);
                
                // hash_equals agora para verificar se senha do banco é igual a que o usuario mandou
                if(($stmt->rowCount() === $qtdParamSql || count($result[0]) === $qtdParamSql) && hash_equals($result[0]['senha'], $senha)) {
                    
                    foreach ($result as $value) {
                        $_SESSION['nome'] = $value['nome'];
                        $_SESSION['cpf'] = $value['cpf'];
                        $_SESSION['email'] = $value['email'];
                        $_SESSION['dataNasc'] = $value['data_nascimento'];
                    }
                    
                    // atualiza o token da sessao
                    $sql_atualiza_token = 'UPDATE cliente SET token_session = :token_session WHERE id = :id;';
                    $stmt = $con->prepare($sql_atualiza_token);
                    
                    $stmt->bindParam(':id', $idCliente);
                    
                    // gera um novo id de sessao quando logar
                    session_regenerate_id();
                    
                    $token_usuario = hash('sha512', $_SERVER['REMOTE_ADDR'].$_SERVER['HTTP_USER_AGENT'].TEXT_SEGURANCA.session_id());
                    
                    $stmt->bindParam('token_session', $token_usuario);
                    
                    if($stmt->execute()) {
                        
                        // verifica se foi retornado algo
                        if($stmt->rowCount() === 0 || count($result[0]) === 0) {
                            $con = null;
                            header('Location: ./logout_usuario.php');
                        }
                        
                        $_SESSION['logado'] = true;
                        $_SESSION['token_user'] = $token_usuario;
                        unset($_SESSION['msgLoginFalha']);
                        unset($senha);
                        $con = null;
                        header('Location: ../PP1_FRONT/Perfil.php');
                        
                    }else {
                        // caso o execute do update falhe
                        $_SESSION['msgLoginFalha'] = "* Email e/ou senha incorretos";
                        unset($_SESSION['logado']);
                        unset($_SESSION['token_user']);
                        unset($senha);
                        $con = null;
                        header('Location: ../PP1_FRONT/'.$_SESSION['urlRequest']);
                    
                    }
                    
                }else {
                    // caso a senha esteja errada
                    $_SESSION['msgLoginFalha'] = "* Email e/ou senha incorretos";
                    unset($_SESSION['logado']);
                    unset($senha);
                    $con = null;
                    header('Location: ../PP1_FRONT/'.$_SESSION['urlRequest']);
                }
                
            }else {
                // caso o execute do select falhe
                $_SESSION['msgLoginFalha'] = "* Email e/ou senha incorretos";
                unset($_SESSION['logado']);
                unset($senha);
                $con = null;
                header('Location: ../PP1_FRONT/'.$_SESSION['urlRequest']);
            }

        }else {
            // caso algumas das variaveis nao tenha valor
            $_SESSION['msgLoginFalha'] = "* Email e/ou senha incorretos";
            unset($_SESSION['logado']);
            unset($senha);
            $con = null;
            header('Location: ../PP1_FRONT/'.$_SESSION['urlRequest']);
        }
} catch (PDOException $e) {
    echo $e->getCode(); echo $e->getMessage();
}

}else {
    $_SESSION['msgLoginFalha'] = "* Recaptcha não foi marcado";
    unset($_POST);
    header('Location: ../PP1_FRONT/'.$_SESSION['urlRequest']);
}