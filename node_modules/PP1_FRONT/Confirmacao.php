<!DOCTYPE html>
<html>
<head>

	<title>
		pagina de confirmacao
	</title>
</head>
<body>

 <!--Propagandas da kabum-->
<?php
header("refresh: 4;Adm.php");
//INCLUE A CONEXÃO E A FUNÇÃO DA CONEXÃO
 require '../login_cadastro_usuario/conexao.php';
 $pdo=getConexao();

//EXPRESSÃO REGULAR PARA PEGAR TODAS IMAGENS

//PEGA OS VALORES PASSADOS PELOS SELECTS
$link = $_POST["link_produto"];
$result_form = $_POST["nome_empresa"];
$result_form2 = $_POST["acao"];

//VERIFICA A QUANTIDADE DE REGISTROS NO BANCO QUE CORRESPONDEM A KABUM
$numero_props_kabum = $pdo->query("select count(tag) from propaganda where link_produto = '$link'");
foreach($numero_props_kabum as $linha){
$quant_propagandas_kabum = $linha["count(tag)"];
}

if($quant_propagandas_kabum == 0){
	if($result_form=="kabum" && $result_form2=="inserir" ){

$url = file_get_contents("$link");
$regex_pegar_imagens = '/<img(\s)src(.*)border="0" height="90" width="90"><\/a>/';
$matches = array();
preg_match_all($regex_pegar_imagens,$url,$matches);

//EXPRESSÃO REGULAR PARA PEGAR A LOGO DA EMPRESA
$regex_logo = '/<img(.*)height="104"\s[a-z]+(.){4}\s\/>/';
$matches_logo = array();
preg_match($regex_logo,$url,$matches_logo);

//EXPRESSÃO REGULAR PARA EDITAR PARTE DA TAG HTML DA LOGO
$regex_editar_logo = '/"288"(.)+"104"/';
$exibir_logo = preg_replace($regex_editar_logo,'"100" height="30"',$matches_logo[0]);

//EXPRESSÃO PARA PEGAR A DESCRIÇÃO DO PRODUTO
$regex_desc = '/<span class="H-titulo"><a(.+)<\/span>/';
$matches_desc = array();
$exibir_desc = preg_match_all($regex_desc,$url,$matches_desc);

//EXPRESSÃO REGULAR PARA PEGAR O PREÇO
$regex_preco ='/listagem-precoavista">(.*)<\/div>/';
$matches_preco = array();
$exibir_preco = preg_match_all($regex_preco, $url, $matches_preco);

		for($i=0; $i<$exibir_preco; $i++){
			$exibir[$i] = $matches[0][$i];
			$exibir_des[$i]= $matches_desc[0][$i];
			$exibir_prec[$i] = " ".$matches_preco[1][$i];
			
			//CONTAINERS DAS PROPAGANDAS
			$containerPropaganda = '  <div class="col-sm-4">
			<div class="panel panel-primary">
				<div class="panel-heading">'.$exibir_logo.'<a href="../login_cadastro_usuario/adicionar_carrinho.php?produto=&loja=kabum" id="estrela" class="estrela-vazia"></a></div>
				<div class="panel-body" id="tamanho">'.$exibir[$i].$exibir_prec[$i]." <i>a vista</i>"."<br>$exibir_des[$i]".'</div>
				<div class="panel-footer"><button class="btn btn-warning">clique para comprar</button></div>
			</div>
			<hr>
		  </div>
		  ';
				//limpando os dados
				$containerPropaganda =utf8_encode($containerPropaganda);
				$exibir_des[$i] = utf8_encode($exibir_des[$i]);
				$exibir_prec[$i] = utf8_encode($exibir_prec[$i]);

				$stmt = $pdo->prepare("insert into propaganda (nome_empresa, link_produto, nome_produto ,preco , tag) values(?,?,?,?,?)");
				$stmt->bindValue(1, "kabum");
				$stmt->bindParam(2, $link);
				$stmt->bindParam(3 ,$exibir_des[$i]);
				$stmt->bindParam(4, $exibir_prec[$i]);
				$stmt->bindParam(5, $containerPropaganda);
				if($stmt->execute()){
				echo "inserido"."$i"."<br>";
				}
			}
	}
	//caso seja maior que 0, chama a funcao de excluir tudo
}else if($quant_propagandas_kabum > 0){
	if($result_form=="kabum" && $result_form2=="excluir" ){
		$stmt = $pdo->prepare("delete from propaganda where nome_empresa = ?");
		$stmt->bindValue(1,"kabum");
		if($stmt->execute()){
			echo "excluido";
		}
	}
}
?>
 <!--FIM propagandas da kabum-->

 <!--Propagandas da pichau-->

<?php
//PEGA OS VALORES PASSADOS PELOS SELECTS
$link = $_POST["link_produto"];
$result_form = $_POST["nome_empresa"];
$result_form2 = $_POST["acao"];

//VERIFICA A QUANTIDADE DE REGISTROS NO BANCO QUE CORRESPONDEM A PICHAU
$numero_props_pichau = $pdo->query("select count(tag) from propaganda where link_produto = '$link'");
foreach($numero_props_pichau as $linha){
$quant_propagandas_pichau = $linha["count(tag)"];
}

if($quant_propagandas_pichau==0){
	if($result_form=="pichau" && $result_form2=="inserir"){

$url = file_get_contents("$link");
$regex ='/<img class="product-image-photo"\n(\s)+s(.)+\s+(.)+(\D)+(.)+\s+alt="[a-zA-z0-9\s,-]+(.*\s.+)\/>/';
$matches = array();
preg_match_all($regex,$url,$matches);

//PEGA OS PRECOS
$regex ='/<[a-z\s]+="price-boleto">\s+.{6}à vista(\s[R].{1}[0-9.,0-9]+).+<\/span>/';
$array = array();
$result = preg_match_all($regex, $url, $array);

//PEGA A LOGO
$logo_pichau = '/<img.+pichau.png"\n\s+alt=""\n\s+(.*)\/>/';
$array_logo = array();
preg_match($logo_pichau,$url,$array_logo);

//EDITA A LOGO
$editar_logo = '/width="281"(.*)\/>/';
$logo = preg_replace($editar_logo,' width="100"             height="30"        />',$array_logo[0]);

//PEGA A DESCRICAO
$regex2 = '/<a class="product-item-link"(\s+.*\s+.+">\s+.*)<\/a>/';
$matches2 = array();
$exibir_desc = preg_match_all($regex2, $url,$matches2);

$regex = '/width="500"(\s)+height="500"/';

			for($i = 0; $i<$result; $i++){
					$var1[$i] = preg_replace($regex,' width="90"
					height="90"',$matches[0][$i])."<br>";
					$exibir_des[$i] = $matches2[0][$i];
					

    //CONTAINERS DAS PROPAGANDAS
    if(isset($array[1][$i])){
			$containerPropaganda = '  <div class="col-sm-4">
    <input type ="hidden" value = "">
    <div class="panel panel-primary">
        <div class="panel-heading">'.$logo.'<a href="../login_cadastro_usuario/adicionar_carrinho.php?produto=&loja=pichau" id="estrela" class="estrela-vazia"></a></div>
        <div class="panel-body" id="tamanho">'.$var1[$i]."<b>".$array[1][$i]."</b>"."<br>".$exibir_des[$i].'</div>
        <div class="panel-footer"><button class="btn btn-warning">clique para comprar</button></div>
    </div>
    <hr>
  </div>
';
$stmt = $pdo->prepare("insert into propaganda (nome_empresa, link_produto, nome_produto ,preco , tag) values(?,?,?,?,?)");
				$stmt->bindValue(1, "pichau");
				$stmt->bindParam(2, $link);
				$stmt->bindParam(3 ,$exibir_des[$i]);
				$stmt->bindParam(4, $array[1][$i]);
				$stmt->bindParam(5, $containerPropaganda);
				if($stmt->execute()){
				echo "inserido"."$i"."<br>";
				}
//echo utf8_encode($containerPropaganda);
							}
					}
			}
}else if($quant_propagandas_pichau > 0){
		if($result_form=="pichau" && $result_form2=="excluir" ){
			$stmt = $pdo->prepare("delete from propaganda where nome_empresa = ?");
			$stmt->bindValue(1,"pichau");
			if($stmt->execute()){
				echo "excluido";
			}
		}
	}
?>
</body>
</html>