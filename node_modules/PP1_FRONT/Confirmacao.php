<!DOCTYPE html>
<html>
<head>

	<title>
		pagina de confirmacao
	</title>
</head>
<body>
<?php
header("refresh: 4;Adm.php");
//INCLUE A CONEXÃO E A FUNÇÃO DA CONEXÃO
 require '../login_cadastro_usuario/conexao.php';
 $pdo=getConexao();


//EXPRESSÃO REGULAR PARA PEGAR TODAS IMAGENS
$url = file_get_contents('https://www.kabum.com.br/hardware/placa-de-video-vga?ordem=5&limite=100&pagina=1&string=');
$regex_pegar_imagens = '/<img(\s)src(.*)border="0" height="90" width="90"><\/a>/';
$matches = array();
preg_match_all($regex_pegar_imagens,$url,$matches);

//EXPRESSÃO REGULAR PARA PEGAR A LOGO DA EMPRESA
$regex_logo = '/<img(.*)height="104"\s[a-z]+(.){4}\s\/>/';
$matches_logo = array();
preg_match($regex_logo,$url,$matches_logo);

//EXPRESSÃO REGULAR PARA EDITAR PARTE DA TAG HTML DA LOGO
$regex_editar_logo = '/"288"(.)+"104"/';
$exibir_logo = preg_replace($regex_editar_logo,'"100" height="30"',$matches_logo[0]);

//EXPRESSÃO PARA PEGAR A DESCRIÇÃO DO PRODUTO
$regex_desc = '/<span class="H-titulo"><a(.+)<\/span>/';
$matches_desc = array();
$exibir_desc = preg_match_all($regex_desc,$url,$matches_desc);

//EXPRESSÃO REGULAR PARA PEGAR O PREÇO
$regex_preco ='/listagem-precoavista">(.*)<\/div>/';
$matches_preco = array();
$exibir_preco = preg_match_all($regex_preco, $url, $matches_preco);

/*for($i=0;$i<100;$i++){
	echo $matches_preco[1][$i]."<br>";
}*/


//PEGA OS VALORES PASSADOS PELO SELECT
$result_form = $_POST["acao"];

//VERIFICA A QUANTIDADE DE REGISTROS NO BANCO QUE CORRESPONDEM A KABUM
$numero_props_kabum = $pdo->query("select count(tag) from propaganda where nomeEmpresa = 'kabum'");
foreach($numero_props_kabum as $linha){
$quant_propagandas_kabum = $linha["count(tag)"];
}

if($quant_propagandas_kabum == 0){
	if($result_form[0]=="kabum" && $result_form[1]=="inserir" ){
		for($i=0; $i<100; $i++){
			$exibir[$i] = $matches[0][$i];
			$exibir_des[$i]= $matches_desc[0][$i];
			$exibir_prec[$i] = " ".$matches_preco[1][$i];
			
			//CONTAINERS DAS PROPAGANDAS
			$containerPropaganda = '  <div class="col-sm-4">
			<div class="panel panel-primary">
				<div class="panel-heading">'.$exibir_logo.'</div>
				<div class="panel-body" id="tamanho">'.$exibir[$i].$exibir_prec[$i]." <i>a vista</i>"."<br>$exibir_des[$i]".'</div>
				<div class="panel-footer"><button class="btn btn-warning">clique para comprar</button></div>
			</div>
			<hr>
		  </div>
		  ';

				//limpando os dados
				$containerPropaganda =utf8_encode($containerPropaganda);
				$exibir_des[$i] = utf8_encode($exibir_des[$i]);
				$exibir_prec[$i] = utf8_encode($exibir_prec[$i]);



				$stmt = $pdo->prepare("insert into propaganda (Empresa, nomeEmpresa, preco, tag) values(?,?,?,?)");
				$stmt->bindValue(1,  "kabum");
				$stmt->bindParam(2,  $exibir_des[$i]);
				$stmt->bindParam(3,  $exibir_prec[$i]);
				$stmt->bindParam(4,  $containerPropaganda);
				if($stmt->execute()){
				echo "inserido"."$i"."<br>";
				}
				//$inserir=$pdo->query("insert into tags");
				//echo utf8_encode($containerPropaganda);
			}
	}
	//caso seja maior que 0, chama a funcao de excluir tudo
}else if($quant_propagandas_kabum > 0){
	if($result_form[0]=="kabum" && $result_form[1]=="excluir" ){
		$stmt = $pdo->prepare("delete from propaganda where Empresa = ?");
		$stmt->bindValue(1,"kabum");
		if($stmt->execute()){
			echo "excluido";
		}
	}
}

/*if($acao == "inserir"){

$stmt = $pdo->prepare("insert into empresa(nome)values(?)");
$stmt->bindValue(1, "kabum");
echo "nome inserido";
$stmt->execute();
}if($acao == "inserir"){

$pdo = $conexao->prepare("delete (nome) values(?)");
$pdo->bindValue(1, "kabum");

}*/


?>
</body>
</html>